<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø²Ø§Ù…Ù†Ø© Ø£Ù„Ø¹Ø§Ø¨ GameMonetize - Ø¥Ø¯Ø§Ø±Ø© Rabhne</title>
    <link rel="stylesheet" href="../css/style.css?v=2.2">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">ğŸ® Rabhne Admin</div>
            <div class="nav-menu">
                <a href="../index.html" class="nav-link">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
                <a href="index.html" class="nav-link">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</a>
                <a href="games.html" class="nav-link">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</a>
                <a href="gamemonetize-sync.html" class="nav-link active">GameMonetize</a>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="dashboard-header">
                <h1>ğŸ® Ù…Ø²Ø§Ù…Ù†Ø© Ø£Ù„Ø¹Ø§Ø¨ GameMonetize</h1>
                <p>Ø¥Ø¯Ø§Ø±Ø© ÙˆÙ…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ù…Ù† Ù…Ù†ØµØ© GameMonetize</p>
            </div>

            <div class="admin-card">
                <h2>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GameMonetize</h2>
                <div class="form-group">
                    <label>Publisher ID:</label>
                    <input type="text" id="publisherId" placeholder="Ø£Ø¯Ø®Ù„ Publisher ID">
                </div>
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="text" id="apiKey" placeholder="Ø£Ø¯Ø®Ù„ API Key">
                </div>
                <div class="form-group">
                    <label>Site ID:</label>
                    <input type="text" id="siteId" placeholder="Ø£Ø¯Ø®Ù„ Site ID">
                </div>
                <div class="form-group">
                    <label>Game Feed URL:</label>
                    <input type="url" id="gameFeedUrl" value="https://gamemonetize.com/feed.php?format=0&num=50&page=1">
                    <small>Ø±Ø§Ø¨Ø· Game Feed Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ - ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</small>
                </div>
                <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>

            <div class="admin-card">
                <h2>ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2>
                <p>Ø§Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ù…Ù† GameMonetize ÙˆØ£Ø¶ÙÙ‡Ø§ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ</p>
                <div class="sync-controls">
                    <button class="btn btn-large btn-primary" onclick="syncGames()">
                        ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ø¢Ù†
                    </button>
                    <button class="btn btn-secondary" onclick="testConnection()">
                        ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                    </button>
                </div>
                <div id="syncStatus" class="sync-status"></div>
            </div>

            <div class="admin-card">
                <h2>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalGames">0</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="gmGames">0</div>
                        <div class="stat-label">Ø£Ù„Ø¹Ø§Ø¨ GameMonetize</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeGames">0</div>
                        <div class="stat-label">Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù†Ø´Ø·Ø©</div>
                    </div>
                </div>
            </div>

            <div class="admin-card">
                <h2>ğŸ® Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©</h2>
                <div id="gamesList" class="games-list">
                    <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="../js/firebase-config.js?v=2.2"></script>
    <script src="../js/auth.js?v=2.2"></script>
    <script src="../js/gamemonetize.js?v=2.2"></script>
    
    <script>
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
        auth.onAuthStateChanged(async (user) => {
            if (!user) {
                window.location.href = '../index.html';
                return;
            }
            
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            
            if (!userData || !userData.isAdmin) {
                alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø¥Ø¯Ø§Ø±ÙŠØ©');
                window.location.href = '../index.html';
                return;
            }
            
            loadGameStats();
            loadGamesList();
        });

        // Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GameMonetize
        function saveConfig() {
            const publisherId = document.getElementById('publisherId').value;
            const apiKey = document.getElementById('apiKey').value;
            const siteId = document.getElementById('siteId').value;
            const gameFeedUrl = document.getElementById('gameFeedUrl').value;
            
            if (!gameFeedUrl) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Game Feed URL Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }
            
            // Ø­ÙØ¸ ÙÙŠ localStorage
            localStorage.setItem('gm_publisher_id', publisherId);
            localStorage.setItem('gm_api_key', apiKey);
            localStorage.setItem('gm_site_id', siteId);
            localStorage.setItem('gm_game_feed_url', gameFeedUrl);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
            GAMEMONETIZE_CONFIG.publisherId = publisherId;
            GAMEMONETIZE_CONFIG.apiKey = apiKey;
            GAMEMONETIZE_CONFIG.siteId = siteId;
            GAMEMONETIZE_CONFIG.gameFeedUrl = gameFeedUrl;
            
            showMessage('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
        async function testConnection() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerHTML = '<p>ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...</p>';
            
            try {
                const games = await fetchGameMonetizeGames();
                console.log('Test connection result:', games);
                
                const gamesList = Array.isArray(games) ? games : (games.games || []);
                
                if (gamesList.length > 0) {
                    statusEl.innerHTML = `<p style="color: green;">âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­! ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${gamesList.length} Ù„Ø¹Ø¨Ø©</p>`;
                } else {
                    statusEl.innerHTML = '<p style="color: orange;">âš ï¸ Ø§Ù„Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­ Ù„ÙƒÙ† Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù„Ø¹Ø§Ø¨ - ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Game Feed</p>';
                }
            } catch (error) {
                console.error('Connection test error:', error);
                statusEl.innerHTML = `<p style="color: red;">âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}<br><small>ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Game Feed ÙÙŠ Ø­Ø³Ø§Ø¨ GameMonetize</small></p>`;
            }
        }

        // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        async function syncGames() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerHTML = '<p>ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨...</p>';
            
            try {
                await syncGameMonetizeGames();
                statusEl.innerHTML = '<p style="color: green;">âœ… ØªÙ… Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­!</p>';
                loadGameStats();
                loadGamesList();
            } catch (error) {
                statusEl.innerHTML = `<p style="color: red;">âŒ ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©: ${error.message}</p>`;
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        async function loadGameStats() {
            try {
                const gamesSnapshot = await db.collection('games').get();
                const gmGamesSnapshot = await db.collection('games').where('source', '==', 'gamemonetize').get();
                const activeGamesSnapshot = await db.collection('games').where('active', '==', true).get();
                
                document.getElementById('totalGames').textContent = gamesSnapshot.size;
                document.getElementById('gmGames').textContent = gmGamesSnapshot.size;
                document.getElementById('activeGames').textContent = activeGamesSnapshot.size;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨
        async function loadGamesList() {
            try {
                const gamesSnapshot = await db.collection('games')
                    .where('source', '==', 'gamemonetize')
                    .limit(10)
                    .get();
                
                const gamesList = document.getElementById('gamesList');
                
                if (gamesSnapshot.empty) {
                    gamesList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù„Ø¹Ø§Ø¨ GameMonetize</p>';
                    return;
                }
                
                let html = '';
                gamesSnapshot.forEach(doc => {
                    const game = doc.data();
                    html += `
                        <div class="game-item">
                            <img src="${game.thumbnail}" alt="${game.title}" style="width: 100px; height: 60px; object-fit: cover;">
                            <div>
                                <h4>${game.title}</h4>
                                <p>Ø§Ù„ÙØ¦Ø©: ${game.category}</p>
                                <p>Ø§Ù„Ø­Ø§Ù„Ø©: ${game.active ? 'âœ… Ù†Ø´Ø·' : 'âŒ ØºÙŠØ± Ù†Ø´Ø·'}</p>
                            </div>
                            <div>
                                <a href="../game.html?slug=${game.slug}" class="btn btn-sm btn-primary">ØªØ¬Ø±Ø¨Ø©</a>
                            </div>
                        </div>
                    `;
                });
                
                gamesList.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading games list:', error);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
        window.addEventListener('load', () => {
            const publisherId = localStorage.getItem('gm_publisher_id');
            const apiKey = localStorage.getItem('gm_api_key');
            const siteId = localStorage.getItem('gm_site_id');
            const gameFeedUrl = localStorage.getItem('gm_game_feed_url');
            
            if (publisherId) document.getElementById('publisherId').value = publisherId;
            if (apiKey) document.getElementById('apiKey').value = apiKey;
            if (siteId) document.getElementById('siteId').value = siteId;
            if (gameFeedUrl) document.getElementById('gameFeedUrl').value = gameFeedUrl;
        });
    </script>
</body>
</html>