<!DOCTYPE html>
<html>
<head>
    <title>حذف الألعاب المكررة</title>
</head>
<body>
    <h1>حذف الألعاب المكررة</h1>
    <button onclick="removeDuplicates()">حذف المكررات</button>
    <div id="result"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <script>
        async function removeDuplicates() {
            try {
                const games = await db.collection('games').get();
                const gamesByTitle = {};
                const toDelete = [];

                games.forEach(doc => {
                    const game = doc.data();
                    const title = game.title;
                    
                    if (gamesByTitle[title]) {
                        // Keep the newer one, delete the older
                        const existing = gamesByTitle[title];
                        const currentTime = game.createdAt ? game.createdAt.toMillis() : 0;
                        const existingTime = existing.data.createdAt ? existing.data.createdAt.toMillis() : 0;
                        
                        if (currentTime > existingTime) {
                            toDelete.push(existing.id);
                            gamesByTitle[title] = { id: doc.id, data: game };
                        } else {
                            toDelete.push(doc.id);
                        }
                    } else {
                        gamesByTitle[title] = { id: doc.id, data: game };
                    }
                });

                // Delete duplicates
                for (const id of toDelete) {
                    await db.collection('games').doc(id).delete();
                    console.log('Deleted:', id);
                }

                document.getElementById('result').innerHTML = `تم حذف ${toDelete.length} لعبة مكررة`;
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('result').innerHTML = 'خطأ: ' + error.message;
            }
        }
    </script>
</body>
</html>